#!/usr/bin/env bash

set -e

VERSION=$(npm pkg get version | tr -d \")
DEFAULT_BRANCH_NAME="release/${VERSION}"

help() {
  echo -e "Usage: $0 [OPTIONS]"
  echo -e ""
  echo -e "Create a release branch off of development and push it to origin. By default, the branch name will follow the format 'release/YYYY-MM-DD'."
  echo -e ""
  echo -e "Note: This assumes that you have access to push to GitHub."
  echo -e "      If a branch already exists for the specified name, then this script will fail."
  echo -e ""
  echo -e "Options:"
  echo -e ""
  echo -e "  -h \t Print this message. All other options will be ignored if this is included."
  echo -e "  -c \t The commit-ish to create the release branch off of. Default 'origin/development'."
  echo -e "  -b \t Specify the branch name to create."
  echo -e "  -d \t Do a dry run."
  echo -e ""
  echo -e "Examples:"
  echo -e "  > $0"
  echo -e ""
  echo -e "  This will:"
  echo -e "    1) Do a fetch from 'origin'."
  echo -e "    2) Create branch '${DEFAULT_BRANCH_NAME}' off of 'origin/development'."
  echo -e "    3) Push this branch to origin (GitHub)."
  echo -e ""
  echo -e "  > $0 -b my-fun-branch -c 8fdc797"
  echo -e ""
  echo -e "  This will:"
  echo -e "    1) Do a fetch from 'origin'."
  echo -e "    2) Create branch 'my-fun-branch' off of '8fdc797'."
  echo -e "    3) Push this branch to origin (GitHub)."
  echo -e ""
  echo -e "  > $0 -b my-fun-branch -c 8fdc797 -d"
  echo -e ""
  echo -e "  This will"
  echo -e "    1) Do a fetch from 'origin'."
  echo -e "    2) Create branch 'my-fun-branch' off of '8fdc797'."
  echo -e "    3) Stop. This will not push to GitHub as it is a 'dry run'."
  echo -e ""
}

BRANCH_NAME="${DEFAULT_BRANCH_NAME}"
COMMITISH="origin/development"
DRY_RUN="no"

while getopts ":hdc:b:" opt; do
  case $opt in
    c)
      COMMITISH=$OPTARG
      ;;
    b)
      BRANCH_NAME=$OPTARG
      ;;
    h)
      help
      exit 0
      ;;
    d)
      DRY_RUN="yes"
      ;;
    :)
      echo "Option -$OPTARG requires an argument." >&2
      echo ""
      help
      exit 1
  esac
done

check_git() {
  command -v git >/dev/null 2>&1 || { echo >&2 "You need have the 'git' command installed in order to continue.  Aborting."; exit 1; }
}

fetch_origin() {
  git fetch origin
}

create_release_branch() {
  BRANCH_NAME=$1
  COMMITISH=$2
  git checkout -b $BRANCH_NAME $COMMITISH
}

push_to_origin() {
  DRY_RUN=$1
  BRANCH_NAME=$2

  if [[ "$DRY_RUN" == "no" ]]; then
    git push -u origin $BRANCH_NAME
  else
    echo "(not pushing $BRANCH_NAME to origin since this is a dry run)"
  fi
}

if [[ "$DRY_RUN" == "yes" ]]; then
  echo "Doing a dry run..."
  echo ""
fi

check_git

fetch_origin
create_release_branch $BRANCH_NAME $COMMITISH
push_to_origin $DRY_RUN $BRANCH_NAME
